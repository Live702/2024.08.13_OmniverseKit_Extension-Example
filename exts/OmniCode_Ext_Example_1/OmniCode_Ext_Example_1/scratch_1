
import omni.ext
import omni.ui as ui
from omni.kit.widget.viewport import ViewportWidget

import omni.usd
import omni.physx as physx

from pxr import UsdGeom, Gf

import sys

#import pyautogui

class InscicoExample_1Extension(omni.ext.IExt):
    def __init__(self):
        print("trace")
        self.box_rendered = False

    def on_startup(self, ext_id):
        print("[inscico.example_1] inscico example_1 startup")

        self._window = ui.Window("My Window", width=1280, height=720+20)
        with self._window.frame:
            with ui.VStack():
                # Viewport section
                self.viewport_widget = ViewportWidget(resolution=(1280, 720))
                self.viewport_api = self.viewport_widget.viewport_api

                # Set camera position (updated approach using get_viewport_from_widget)
                viewport_interface = get_viewport_from_widget(self.viewport_widget)
                
                if viewport_interface:
                    viewport_window = viewport_interface.get_viewport_window()
                    if viewport_window:
                        camera = viewport_window.get_active_camera()
                        if camera:
                            # Calculate camera position 3 meters away from the box
                            camera_position = Gf.Vec3d(3, 1.5, 0)  # Adjust height (1.5) if needed

                            # Set camera to look at the box
                            camera.set_look_at(Gf.Vec3d(0, 0, 0), Gf.Vec3d(0, 1, 0)) 
                            camera.set_position(camera_position)

                if not self.box_rendered: 
                    self.add_box_to_scene()

    def on_shutdown(self):
        print("[inscico.example_1] inscico example_1 shutdown")
        self.viewport_widget.destroy()
        self._window.destroy()

    def add_box_to_scene(self):
        self.box_rendered = True

        stage = omni.usd.get_context().get_stage()
        prim_path = "/World/box" 

        cube_prim = stage.DefinePrim(prim_path, "Cube")

        UsdGeom.XformCommonAPI(cube_prim).SetTranslate((0, 0, 0)) 
        UsdGeom.Cube(cube_prim).CreateSizeAttr(1)

# camera = viewport_window.get_active_camera()
# camera_position = Gf.Vec3d(3, 1.5, 0) 